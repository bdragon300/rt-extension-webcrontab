<& /Admin/Elements/Header, Title => $title &>
<& /Elements/Tabs &>

<& /Elements/ListActions, actions => \@results &>

<style>
    .el span.label {
        display: block;
        text-align: left;
    }
    .elgrp div.el {
        display: inline-block;
        margin: 10px 5px;
        vertical-align: top;
    }
</style>

<form action="/Admin/Tools/WebCrontab/edit.html?id=<% $id %>&Create=<% $Create %>" method="post">
%   my $event_to_display = @results ? \%new_event : \%current_event;
    <& Elements/CrontabEvent, filling => $available_values, data => $event_to_display, old_data => \%current_event, captions => $classes &>
    <& /Elements/Submit, Name => 'submit', Label => loc('Save Changes') &>
%   if ($Create == 0) {
        <& /Elements/Submit, Name => 'remove', Label => loc('REMOVE'), OnClick => "return confirm('" . loc("Do you want to remove event?") . "');" &>
%   }
</form>

<%init>
use Data::Dumper qw{Dumper};

my $title = loc('Crontab event');
unless ($session{'CurrentUser'}->HasRight( Object=> $RT::System, Right => 'SuperUser')) {
    Abort(loc('This feature is only available to system administrators'));
}

my $available_values = RT::Extension::WebCrontab::get_available_values();
my $classes = RT::Extension::WebCrontab::get_classes();

my $crontab = RT::Extension::WebCrontab::load_crontab();
my $events = $crontab->{'events'};
undef $crontab;

my @results;
my %current_event = ();
my %new_event = ();
my %old_event = ();

$id += 0;
$Create += 0;
unless ($Create) {
    if ( ! defined($events->[$id])
        || $events->[$id]->{'skip'})
    {
        Abort(loc('ERROR: Invalid id'));
    }
}


unless ($Create) {
    %current_event = %{$events->[$id]};
    # delete not significant keys
    delete @current_event{qw/obj skip/};
    #delete keys with undef values, i.e. ignore crontool parameters without args
    delete @current_event{grep ! defined $current_event{$_}, keys %current_event}; 
}

if ($ARGS{'remove'}) {
    splice(@$events, $id, 1);

    my ($res, $msg) = RT::Extension::WebCrontab::save_events($events);
    if ($res) {
        push @results, loc('Crontab saved');
    } else {
        push @results, loc('ERROR: Cannot save crontab: [_1]', $msg);
    }

    MaybeRedirectForResults(
        Actions   => \@results,
        Path      => "/Admin/Tools/WebCrontab"
    );
}

if ($ARGS{'submit'}) {
    %new_event = map { $_ => $ARGS{$_} } 
        grep { $ARGS{$_} } 
        (@$classes, 'expression');
    %old_event = map { $_ => $ARGS{'old-' . $_} } 
        grep { $ARGS{'old-' . $_} } 
        (@$classes, 'expression');

    my @check = (
        qr/^\*$|^([1-5]?[0-9])([,\/\-][1-5]?[0-9])*$/,
        qr/^\*$|^(1?[0-9]|2[0-3])([,\/\-]1?([0-9]|2[0-3]))*$/,
        qr/^[*?]$|^([1-9]|[1-2][0-9]|3[0-1])[LW]?(([,\/\-]([1-9]|[1-2][0-9]|3[0-1]))[LW]?)*$/,
        qr/^\*$|^([1-9]|1[0-2]|jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)([,\/\-]([1-9]|1[0-2]|jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec))*$/i,
        qr/^[*?]$|^([0-6]L?|sun|mon|tue|wed|thu|fri|sat)([#,\/\-]([0-6]L?|sun|mon|tue|wed|thu|fri|sat))*$/i,
        qr/^\*$|^(19[7-9][0-9]|20[0-9][0-9])([,\/\-](19[7-9][0-9]|20[0-9][0-9]))*$/, # Optional
        qr/^$/
    );
    my @errors = grep ! ($_ =~ shift @check), split(/ /, $new_event{'expression'}, scalar(@check));
    push(@errors, $new_event{'expression'} . '...') if (scalar(@check) > 2);  # Incomplete expression
    @errors = () if ($new_event{'expression'} =~ /^@(reboot|yearly|annually|monthly|weekly|daily|midnight|hourly)$/i);

    if (@errors) {
        push @results, loc("ERROR: Error in the expression at \"[_1]\"", $errors[0]);
    }

    # Make sure that current crontab event and the old event (had been existing by edit) must be identical
    unless ($Create) {
        no warnings;  # smartmatch op use
        if ( ! (%old_event ~~ %current_event)
            || (grep {$current_event{$_} ne $old_event{$_}} keys %current_event))
        {
            push @results, loc("ERROR: Crontab changed since last read. Changes was loaded");
        }
    }
    
    unless (@results) {
        $id = scalar(@$events) if ($Create);
        $events->[$id] = \%new_event;

        my ($res, $msg) = RT::Extension::WebCrontab::save_events($events);

        if ($res) {
            push @results, loc('Crontab saved');
        } else {
            push @results, loc('ERROR: Cannot save crontab: [_1]', $msg);
        }

        MaybeRedirectForResults(
            Actions   => \@results,
            Path      => "/Admin/Tools/WebCrontab"
        );
    }
}
</%init>

<%args>
$id => 0
$Create => 0
$Remove => 0
</%args>